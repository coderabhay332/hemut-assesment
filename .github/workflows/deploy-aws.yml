name: Deploy to AWS Ubuntu

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend to AWS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r *.py deploy/
        cp requirements.txt deploy/
        tar -czf backend-deploy.tar.gz deploy/

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts

    - name: Copy files to server
      run: |
        scp backend-deploy.tar.gz ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/tmp/
        scp deploy.sh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/tmp/

    - name: Deploy on server
      run: |
        ssh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
          cd /tmp
          chmod +x deploy.sh
          sudo ./deploy.sh
        EOF

    - name: Deployment summary
      run: |
        echo " Backend deployed to AWS Ubuntu successfully"
        echo " Server: ${{ secrets.AWS_HOST }}"
        echo "Backend deployed to AWS Ubuntu successfully"
